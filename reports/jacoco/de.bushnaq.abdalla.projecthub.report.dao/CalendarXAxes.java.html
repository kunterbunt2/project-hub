<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CalendarXAxes.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project-hub</a> &gt; <a href="index.source.html" class="el_package">de.bushnaq.abdalla.projecthub.report.dao</a> &gt; <span class="el_source">CalendarXAxes.java</span></div><h1>CalendarXAxes.java</h1><pre class="source lang-java linenums">/*
 *
 * Copyright (C) 2025-2025 Abdalla Bushnaq
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 */

package de.bushnaq.abdalla.projecthub.report.dao;

import de.bushnaq.abdalla.projecthub.report.AbstractCanvas;
import de.bushnaq.abdalla.projecthub.report.AbstractRenderer;
import de.bushnaq.abdalla.util.Util;
import de.bushnaq.abdalla.util.date.DateUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.awt.*;
import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.Month;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalField;
import java.time.temporal.WeekFields;
import java.util.Locale;

public class CalendarXAxes {
    public static final  int                      DAY_OF_MONTH_MIN_DAY_WIDTH = 16;
    private static final int                      DAY_OF_WEEK_MIN_DAY_WIDTH  = 10;
    private static final int                      MONTH_MIN_DAY_WIDTH        = 1;
    private static final int                      WEEK_MIN_DAY_WIDTH         = 2;
    private              boolean                  calendarAtBottom;
    public               CalendarElement          dayOfMonth;
    public               CalendarElement          dayOfWeek;
<span class="nc" id="L44">    private final        DateTimeFormatter        imageMapSdf                = DateTimeFormatter.ofPattern(&quot;EEEE dd MMMM yyyy&quot;, Util.locale);</span>
<span class="nc" id="L45">    private final        Logger                   logger                     = LoggerFactory.getLogger(this.getClass());</span>
    public               CalendarMilestoneElement milestone;
    private final        Milestones               milestones;
    public               CalendarElement          month;
    private final        AbstractRenderer         parent;
    private final        int                      postRun;
    private final        int                      preRun;
<span class="nc" id="L52">    private final        DateTimeFormatter        sdf                        = DateTimeFormatter.ofPattern(&quot;d&quot;, Util.locale);</span>
<span class="nc" id="L53">    private final        DateTimeFormatter        sdfMMMdd                   = DateTimeFormatter.ofPattern(&quot;MMM.d&quot;, Util.locale);</span>
    public               CalendarElement          week;
<span class="nc" id="L55">    private              int                      width                      = 0;</span>
    private              int                      x;
    public               CalendarElement          year;

    /**
     * @param parent
     * @param preRun,  how many days to draw prior to the time range we are
     *                 interested in
     * @param postRun, how many days to draw post to the time range we are
     *                 interested in
     */
<span class="nc" id="L66">    public CalendarXAxes(AbstractRenderer parent, int preRun, int postRun) {</span>
<span class="nc" id="L67">        this.parent     = parent;</span>
<span class="nc" id="L68">        this.preRun     = preRun;</span>
<span class="nc" id="L69">        this.postRun    = postRun;</span>
<span class="nc" id="L70">        this.milestones = parent.milestones;</span>
<span class="nc" id="L71">        int margine = 4;</span>
<span class="nc" id="L72">        year       = new CalendarElement(new Font(Font.SANS_SERIF, Font.PLAIN, 14), null, null, 13 + margine);</span>
<span class="nc" id="L73">        month      = new CalendarElement(new Font(Font.SANS_SERIF, Font.PLAIN, 12), null, null, 12 + margine);</span>
<span class="nc" id="L74">        week       = new CalendarElement(new Font(Font.SANS_SERIF, Font.PLAIN, 10), null, null, 10 + margine);</span>
<span class="nc" id="L75">        dayOfMonth = new CalendarElement(new Font(Font.SANS_SERIF, Font.BOLD, 10), null, 20, 10 + margine);</span>
<span class="nc" id="L76">        dayOfWeek  = new CalendarElement(new Font(Font.SANS_SERIF, Font.BOLD, 10), null, 20, 10 + margine);</span>
<span class="nc" id="L77">        milestone  = new CalendarMilestoneElement(null, null, 11, 10 + margine, new Font(Font.SANS_SERIF, Font.BOLD, 10), null, 13, new Font(Font.SANS_SERIF, Font.PLAIN, 11));</span>
<span class="nc" id="L78">    }</span>

    protected int calculateDayX(LocalDate date) {
<span class="nc" id="L81">        int firstMilestoneX = x + dayOfWeek.getWidth() / 2;</span>
<span class="nc" id="L82">        return firstMilestoneX + (DateUtil.calculateDays(milestones.firstMilestone, date) + preRun) * dayOfWeek.getWidth();</span>
    }

    public void drawCalendar(boolean drawDays) {
<span class="nc" id="L86">        LocalDate firstDay = DateUtil.addDay(milestones.firstMilestone, -preRun);</span>
        //TODO why are we ignoring postRun days?
<span class="nc" id="L88">        LocalDate lastDay           = DateUtil.max(milestones.lastMilestone, DateUtil.addDay(milestones.firstMilestone, parent.days - 1));</span>
<span class="nc" id="L89">        boolean   yearWasDrawn      = false;</span>
<span class="nc" id="L90">        boolean   monthWasDrawn     = false;</span>
<span class="nc" id="L91">        boolean   firstWeekWasDrawn = false;</span>

        // logger.trace(String.format(&quot;%s first=%s, last=%s, day.width=%d&quot;,
        // father.getImageName(), DateUtil.createDateString(firstDay, sdtmf),
        // DateUtil.createDateString(lastDay, sdtmf), dayOfWeek.width));
<span class="nc bnc" id="L96" title="All 2 branches missed.">        for (int phase = 0; phase &lt; 5; phase++) {</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">            for (LocalDate currentDay = firstDay; currentDay.isBefore(lastDay) || currentDay.isEqual(lastDay); currentDay = currentDay.plusDays(1)) {</span>
                // if (phase == 4)
                // logger.trace(String.format(&quot;first=%s, last=%s, current=%s&quot;,
                // Util.createDateString(firstDay, sdtmf), Util.createDateString(lastDay,
                // sdtmf), Util.createDateString(currentDay, sdtmf)));
<span class="nc" id="L102">                int       daysX    = calculateDayX(currentDay);</span>
<span class="nc" id="L103">                String[]  weekDays = {&quot;M&quot;, &quot;T&quot;, &quot;W&quot;, &quot;T&quot;, &quot;F&quot;, &quot;S&quot;, &quot;S&quot;};</span>
<span class="nc" id="L104">                String[]  months   = {&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;};</span>
<span class="nc" id="L105">                LocalDate startCal = currentDay;</span>

<span class="nc bnc" id="L107" title="All 8 branches missed.">                if (phase == 4 &amp;&amp; ((startCal.getDayOfMonth() == 1 &amp;&amp; startCal.getMonth() == Month.JANUARY) || !yearWasDrawn)) {</span>
                    // --year
                    {
<span class="nc" id="L110">                        LocalDate end = startCal.withMonth(12).withDayOfMonth(31);// new years eve</span>
                        //                        end.set(Calendar.MONTH, 11); // 11 = december
                        //                        end.set(Calendar.DAY_OF_MONTH, 31); // new years eve
<span class="nc bnc" id="L113" title="All 2 branches missed.">                        if (end.isAfter(lastDay)) {</span>
<span class="nc" id="L114">                            end = lastDay;</span>
                        }
<span class="nc" id="L116">                        int x2 = calculateDayX(end) - dayOfWeek.getWidth() / 2;</span>
<span class="nc" id="L117">                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), x2 + dayOfWeek.getWidth(), year.getY(), year.getHeight(),</span>
<span class="nc" id="L118">                                String.valueOf(startCal.getYear()), parent.graphicsTheme.ganttYearTextColor, parent.graphicsTheme.ganttYearBackgroundColor,</span>
<span class="nc" id="L119">                                parent.graphicsTheme.ganttYearBoderColor, year.getFont(), false);</span>
<span class="nc" id="L120">                        yearWasDrawn = true;</span>
<span class="nc" id="L121">                    }</span>
<span class="nc bnc" id="L122" title="All 8 branches missed.">                } else if (phase == 3 &amp;&amp; (startCal.getDayOfMonth() == 1 || !monthWasDrawn) &amp;&amp; isMonthVisible()) {</span>
                    // --month
                    {
<span class="nc" id="L125">                        LocalDate end = startCal.plusMonths(1).withDayOfMonth(1).minusDays(1);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                        if (end.isAfter(lastDay)) {</span>
<span class="nc" id="L127">                            end = lastDay;</span>
                        }
<span class="nc" id="L129">                        int   x2              = calculateDayX(end) - dayOfWeek.getWidth() / 2;</span>
<span class="nc" id="L130">                        Color backgroundColor = parent.graphicsTheme.monthColor[startCal.getMonth().getValue() - 1];</span>
<span class="nc" id="L131">                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), x2 + dayOfWeek.getWidth(), month.getY(), month.getHeight(),</span>
<span class="nc" id="L132">                                months[startCal.getMonth().getValue() - 1], parent.graphicsTheme.ganntMonthTextColor, backgroundColor,</span>
<span class="nc" id="L133">                                parent.graphicsTheme.ganttMonthBorderColor, month.getFont(), false);</span>
<span class="nc" id="L134">                        monthWasDrawn = true;</span>
<span class="nc" id="L135">                    }</span>
<span class="nc bnc" id="L136" title="All 8 branches missed.">                } else if (phase == 2 &amp;&amp; (startCal.getDayOfWeek() == DayOfWeek.MONDAY || !firstWeekWasDrawn) &amp;&amp; isWeekVisible()) {</span>
                    // --week of the year
                    {
<span class="nc" id="L139">                        LocalDate end = DateUtil.getWeekSunday(startCal);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                        if (end.isAfter(lastDay)) {</span>
<span class="nc" id="L141">                            end = lastDay;</span>
                        }
<span class="nc" id="L143">                        int    x2 = calculateDayX(end) - dayOfWeek.getWidth() / 2;</span>
                        String calendarWeek;
<span class="nc bnc" id="L145" title="All 2 branches missed.">                        if (isDayOfWeekVisible()) {</span>
<span class="nc" id="L146">                            TemporalField woy = WeekFields.of(Locale.CANADA).weekOfWeekBasedYear();</span>
<span class="nc" id="L147">                            calendarWeek = &quot;W&quot; + currentDay.get(woy);</span>
<span class="nc" id="L148">                        } else {</span>
<span class="nc" id="L149">                            calendarWeek = DateUtil.createDateString(currentDay, sdf);</span>
                        }
//                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), x2 + dayOfWeek.getWidth(), week.getY(), week.getHeight(), calendarWeek,
//                                parent.graphicsTheme.weekTextColor, parent.graphicsTheme.weekBackgroundColor, parent.graphicsTheme.weekBoderColor,
//                                week.getFont(), false);
<span class="nc" id="L154">                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), x2 + dayOfWeek.getWidth(), week.getY(), week.getHeight() - 1, calendarWeek,</span>
                                parent.graphicsTheme.ganttWeekDayTextColor, parent.graphicsTheme.ganttWeekDayBgColor, parent.graphicsTheme.ganttWeekBoderColor,
<span class="nc" id="L156">                                week.getFont(), false);</span>
<span class="nc" id="L157">                        firstWeekWasDrawn = true;</span>
<span class="nc" id="L158">                    }</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">                } else if (phase == 1 &amp;&amp; isDayOfWeekVisible()) {</span>
                    // --day of Month
                    {
                        Color color;
<span class="nc bnc" id="L163" title="All 4 branches missed.">                        if (startCal.getDayOfWeek() == DayOfWeek.SATURDAY || startCal.getDayOfWeek() == DayOfWeek.SUNDAY) {</span>
//                            color = GraphColorUtil.getDayOfWeekColor(parent.graphicsTheme, startCal);
//                            drawTextBox(daysX - (dayOfMonth.getWidth() / 2 - 1), daysX - (dayOfMonth.getWidth() / 2 - 1) + (dayOfMonth.getWidth() - 1),
//                                    dayOfMonth.getY(), dayOfMonth.getHeight(), &quot;&quot; + startCal.getDayOfMonth(), Color.BLACK, color,
//                                    parent.graphicsTheme.dayOfMonthBorderColor, dayOfMonth.getFont(), true);
<span class="nc" id="L168">                            drawTextBox(daysX - (dayOfMonth.getWidth() / 2 - 1), daysX - (dayOfMonth.getWidth() / 2 - 1) + (dayOfMonth.getWidth() - 1),</span>
<span class="nc" id="L169">                                    dayOfMonth.getY(), dayOfMonth.getHeight(), &quot;&quot; + startCal.getDayOfMonth(), parent.graphicsTheme.ganttWeekendTextColor, parent.graphicsTheme.ganttSundayStripeColor,</span>
<span class="nc" id="L170">                                    parent.graphicsTheme.ganttDayOfMonthBorderColor, dayOfMonth.getFont(), true);</span>
                        } else {
//                            color = parent.graphicsTheme.weekDayBgColor;
//                            drawTextBox(daysX - (dayOfMonth.getWidth() / 2 - 1), daysX - (dayOfMonth.getWidth() / 2 - 1) + (dayOfMonth.getWidth() - 1),
//                                    dayOfMonth.getY(), dayOfMonth.getHeight(), &quot;&quot; + startCal.getDayOfMonth(), parent.graphicsTheme.dayOfMonthTextColor, color,
//                                    parent.graphicsTheme.dayOfMonthBorderColor, dayOfMonth.getFont(), true);
<span class="nc" id="L176">                            drawTextBox(daysX - (dayOfMonth.getWidth() / 2 - 1), daysX - (dayOfMonth.getWidth() / 2 - 1) + (dayOfMonth.getWidth() - 1),</span>
<span class="nc" id="L177">                                    dayOfMonth.getY(), dayOfMonth.getHeight(), &quot;&quot; + startCal.getDayOfMonth(), parent.graphicsTheme.ganttNormalDayTextColor, parent.graphicsTheme.ganttWeekDayBgColor,</span>
<span class="nc" id="L178">                                    parent.graphicsTheme.ganttDayOfMonthBorderColor, dayOfMonth.getFont(), true);</span>
                        }

                        // father.graphics2D.setColor(graphicsTheme.dayDiagramBorderColor);
                    }

                    // --day of week
                    {
<span class="nc" id="L186">                        Color color = GraphColorUtil.getDayOfWeekStripeColor(parent.graphicsTheme, startCal);</span>
//                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), daysX - (dayOfWeek.getWidth() / 2 - 1) + (dayOfWeek.getWidth() - 1),
//                                dayOfWeek.getY(), dayOfWeek.getHeight(), weekDays[startCal.getDayOfWeek().getValue() - 1], parent.graphicsTheme.dayTextColor,
//                                color, parent.graphicsTheme.dayBorderColor, dayOfWeek.getFont(), true);
<span class="nc" id="L190">                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), daysX - (dayOfWeek.getWidth() / 2 - 1) + (dayOfWeek.getWidth() - 1),</span>
<span class="nc" id="L191">                                dayOfWeek.getY(), dayOfWeek.getHeight(), weekDays[startCal.getDayOfWeek().getValue() - 1], parent.graphicsTheme.ganttWeekDayTextColor,</span>
<span class="nc" id="L192">                                color, parent.graphicsTheme.ganttDayBorderColor, dayOfWeek.getFont(), true);</span>
//                        parent.graphics2D.setColor(parent.graphicsTheme.dayDiagramBorderColor);
//                        parent.graphics2D.fillRect(daysX - (dayOfWeek.getWidth() / 2 - 1) + (dayOfWeek.getWidth() - 1), milestone.flagY, 1, milestone.flagHeight - 1);
<span class="nc" id="L195">                    }</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                } else if (phase == 0) {</span>
                    {
<span class="nc bnc" id="L198" title="All 4 branches missed.">                        if (drawDays &amp;&amp; isDayBarsVisible()) {</span>
<span class="nc" id="L199">                            parent.drawDayBars(currentDay);</span>
                        }
                    }
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    if (milestonesVisible()) {</span>
<span class="nc" id="L203">                        Color color = GraphColorUtil.getDayOfWeekStripeColor(parent.graphicsTheme, startCal);</span>
<span class="nc" id="L204">                        parent.graphics2D.setColor(color);</span>
                        //                        father.graphics2D.setColor(Color.red);
//                        parent.graphics2D.fillRect(daysX - (dayOfWeek.getWidth() / 2 - 1), milestone.flagY, dayOfWeek.getWidth() - 1, milestone.flagHeight - 1);
<span class="nc" id="L207">                        drawTextBox(daysX - (dayOfWeek.getWidth() / 2 - 1), daysX - (dayOfWeek.getWidth() / 2 - 1) + (dayOfWeek.getWidth() - 1),</span>
<span class="nc" id="L208">                                milestone.flagY, milestone.flagHeight, null, parent.graphicsTheme.ganttWeekDayTextColor,</span>
                                color, parent.graphicsTheme.ganttDayBorderColor, null, true);
                    }
                }
            }
        }
<span class="nc" id="L214">    }</span>

    public String drawMilestone(Milestone m, LocalDate time, int x, Color fillColor, String text, boolean drawMilestone, Color flagTextColor) {
<span class="nc" id="L217">        return drawMilestone(m, time, x, milestone.y, fillColor, text, drawMilestone, milestone.flagY, flagTextColor, true, true);</span>
    }

    public String drawMilestone(Milestone m, LocalDate time, int x, int y, Color fillColor, String text, boolean drawMilestone, Integer flagY,
                                Color flagTextColor, boolean drawFlag, boolean drawNowLine) {
<span class="nc" id="L222">        String imageMap = &quot;&quot;;</span>
<span class="nc" id="L223">        int    centerX  = x;</span>
<span class="nc" id="L224">        int    centerY  = y;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (text.startsWith(&quot;N&quot;)) {</span>
            // now line
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (drawNowLine) {</span>
<span class="nc" id="L228">                parent.graphics2D.setColor(GraphicsTheme.COLOR_DARK_RED);</span>
<span class="nc" id="L229">                parent.graphics2D.fillRect(x, parent.diagram.y, 2, parent.diagram.height);</span>
<span class="nc" id="L230">                int d = Math.max(dayOfWeek.getWidth() / 3, 6);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                if (calendarAtBottom) {</span>
<span class="nc" id="L232">                    parent.graphics2D.fillOval(x + 1 - d / 2, parent.diagram.y - d / 2, d, d);</span>
                } else {
<span class="nc" id="L234">                    parent.graphics2D.fillOval(x + 1 - d / 2, parent.diagram.y + parent.diagram.height - d, d, d);</span>
                }
            }
        }
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (drawMilestone) {</span>
            // draw milestone
<span class="nc" id="L240">            parent.graphics2D.setFont(milestone.font);</span>
<span class="nc" id="L241">            parent.graphics2D.setColor(fillColor);</span>
<span class="nc" id="L242">            parent.graphics2D.fillRect(centerX - milestone.width / 2, centerY, milestone.width, milestone.height - 1);</span>
            //            if (m != null) {
            //                String lable = DateUtil.createDateString(time, imageMapSdf);
            //                String toolTip = String.format(&quot;&lt;b&gt;%s&lt;/b&gt; = %s&lt;br&gt;%s.&lt;br&gt;&quot;, text, m.name, lable);
            //                Shape s = new TitledRectangle(centerX - milestone.width / 2, centerY, milestone.width, milestone.height - 1, toolTip);
            //                father.graphics2D.fill(s);
            //            } else {
            //                Shape s = new Rectangle(centerX - milestone.width / 2, centerY, milestone.width, milestone.height - 1);
            //                father.graphics2D.fill(s);
            //            }
<span class="nc" id="L252">            parent.graphics2D.setColor(parent.graphicsTheme.milestoneTextColor);</span>
<span class="nc" id="L253">            FontMetrics fm        = parent.graphics2D.getFontMetrics();</span>
<span class="nc" id="L254">            int         maxAscent = fm.getMaxAscent();</span>
            {
<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (m != null) {</span>
<span class="nc" id="L257">                    String lable   = DateUtil.createDateString(time, imageMapSdf);</span>
<span class="nc" id="L258">                    String toolTip = String.format(&quot;&lt;b&gt;%s&lt;/b&gt; = %s&lt;br&gt;%s.&lt;br&gt;&quot;, text, m.name, lable);</span>
<span class="nc" id="L259">                    parent.graphics2D.drawString(text, x - milestone.width / 2 + 2, centerY + milestone.height / 2 + maxAscent / 2 - 2, toolTip);</span>
<span class="nc" id="L260">                } else {</span>
<span class="nc" id="L261">                    parent.graphics2D.drawString(text, x - milestone.width / 2 + 2, centerY + milestone.height / 2 + maxAscent / 2 - 2);</span>
                }
            }
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (m != null) {</span>
                // imageMap
<span class="nc" id="L266">                String lable = DateUtil.createDateString(time, imageMapSdf);</span>
<span class="nc" id="L267">                imageMap += &quot;&lt;area alt=\&quot;&lt;font face=arial&gt;&quot;;</span>
<span class="nc" id="L268">                imageMap += String.format(&quot;&lt;b&gt;%s&lt;/b&gt; = %s&lt;br&gt;%s.&lt;br&gt;&quot;, text, m.name, lable);</span>
<span class="nc" id="L269">                imageMap += String.format(&quot;\&quot; shape=\&quot;rect\&quot; coords=\&quot;%d,%d,%d,%d\&quot;&quot;, AbstractCanvas.transformToMapX(centerX - milestone.width / 2),</span>
<span class="nc" id="L270">                        AbstractCanvas.transformToMapY(centerY), AbstractCanvas.transformToMapX(centerX + milestone.width / 2),</span>
<span class="nc" id="L271">                        AbstractCanvas.transformToMapY(centerY + milestone.height - 1));</span>
<span class="nc" id="L272">                imageMap += &quot; &gt;\n&quot;;</span>
            }
        }
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if (drawMilestone &amp;&amp; drawFlag) {</span>
<span class="nc" id="L276">            parent.graphics2D.setFont(milestone.flagFont);</span>
<span class="nc" id="L277">            FontMetrics fm    = parent.graphics2D.getFontMetrics();</span>
<span class="nc" id="L278">            String      lable = DateUtil.createDateString(time, sdfMMMdd);</span>
<span class="nc" id="L279">            int         width = fm.stringWidth(lable);</span>
            // flag background
<span class="nc" id="L281">            parent.graphics2D.setColor(parent.graphicsTheme.milestoneFlagColor);</span>
<span class="nc" id="L282">            parent.graphics2D.fillRect(x - milestone.width / 2, flagY, width, milestone.flagHeight);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (calendarAtBottom) {</span>
                // flag pole
<span class="nc" id="L285">                parent.graphics2D.setColor(flagTextColor);</span>
<span class="nc" id="L286">                parent.graphics2D.fillRect(centerX, milestone.flagY + milestone.flagHeight - 4, 1, 3);</span>
                // flag
<span class="nc" id="L288">                parent.graphics2D.drawString(lable, x - milestone.width / 2, milestone.flagY + milestone.flagHeight - 5);</span>
            } else {
                // flag pole
<span class="nc" id="L291">                parent.graphics2D.setColor(flagTextColor);</span>
<span class="nc" id="L292">                parent.graphics2D.fillRect(centerX, centerY + milestone.height, 1, 3);</span>
                // flag
<span class="nc" id="L294">                parent.graphics2D.drawString(lable, x - milestone.width / 2, milestone.flagY + milestone.flagHeight - 1);</span>
            }
        }
<span class="nc" id="L297">        return imageMap;</span>
    }

    public void drawMilestones() {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        for (Milestone milestone : milestones.getList()) {</span>
<span class="nc" id="L302">            int x = calculateDayX(milestone.time);</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            drawMilestone(milestone, milestone.time, x, parent.graphicsTheme.ganttRequestMilestoneColor, milestone.symbol, !milestone.hidden,</span>
                    parent.graphicsTheme.futureEventColor);// start
<span class="nc" id="L305">        }</span>
<span class="nc" id="L306">    }</span>

    public void drawTextBox(int x1, int x2, Integer y1, int height, String text, Color textColor, Color backgroundColor, Color borderColor, Font font,
                            boolean centered) {
        {
<span class="nc" id="L311">            parent.graphics2D.setColor(backgroundColor);</span>
<span class="nc" id="L312">            parent.graphics2D.fillRect(x1, y1, x2 - x1, height - 1);</span>
        }
        {
<span class="nc" id="L315">            parent.graphics2D.setColor(borderColor);</span>
<span class="nc" id="L316">            parent.graphics2D.fillRect(x1 - 1, y1 - 1, x2 - x1 + 1, 1);</span>
<span class="nc" id="L317">            parent.graphics2D.fillRect(x2, y1, 1, height - 1);</span>
        }
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (text != null) {</span>
<span class="nc" id="L320">            parent.graphics2D.setFont(font);</span>
<span class="nc" id="L321">            FontMetrics fm    = parent.graphics2D.getFontMetrics();</span>
<span class="nc" id="L322">            int         width = fm.stringWidth(text);</span>
<span class="nc" id="L323">            parent.graphics2D.setColor(textColor);</span>
<span class="nc" id="L324">            int maxAscent = fm.getMaxAscent();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            if (centered) {</span>
<span class="nc" id="L326">                parent.graphics2D.drawString(text, x1 + (x2 - x1) / 2 - width / 2, y1 + height / 2 + (maxAscent + 1) / 2 - 2);</span>
            } else {
<span class="nc" id="L328">                parent.graphics2D.drawString(text, x1 + 1 + 1, y1 + height / 2 + (maxAscent + 1) / 2 - 2);</span>
            }
        }
<span class="nc" id="L331">    }</span>

    public int getHeight() {
<span class="nc" id="L334">        int height = year.getHeight();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (isMonthVisible()) {</span>
<span class="nc" id="L336">            height += month.getHeight();</span>
        }
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (isWeekVisible()) {</span>
<span class="nc" id="L339">            height += week.getHeight();</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (isDayOfWeekVisible()) {</span>
<span class="nc" id="L342">            height += dayOfWeek.getHeight();</span>
<span class="nc" id="L343">            height += dayOfMonth.getHeight();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        } else if (milestonesVisible()) {</span>
<span class="nc" id="L345">            height += milestone.height;</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (milestonesVisible()) {</span>
<span class="nc" id="L348">            height += milestone.flagHeight;</span>
        }
<span class="nc" id="L350">        return height;</span>
    }

    public int getPostRun() {
<span class="nc" id="L354">        return postRun;</span>
    }

    public int getPriRun() {
<span class="nc" id="L358">        return preRun;</span>
    }

    public int getWidth() {
<span class="nc" id="L362">        return width;</span>
    }

    public int getX() {
<span class="nc" id="L366">        return x;</span>
    }

    public int getY() {
<span class="nc" id="L370">        return year.getY();</span>
    }

    public void initPosition(int x, int y) {
<span class="nc" id="L374">        this.x = x;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (calendarAtBottom) {</span>
            // flag
            // milestone, dayOfWeek
            // dayOfMonth
            // week
            // month
            // year

<span class="nc" id="L383">            milestone.flagY = y;</span>
<span class="nc" id="L384">            milestone.y     = milestone.flagY + milestone.flagHeight;</span>
<span class="nc" id="L385">            dayOfWeek.setY(milestone.y);</span>
<span class="nc" id="L386">            dayOfMonth.setY(dayOfWeek.getY() + dayOfWeek.getHeight());</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">            if (isDayOfWeekVisible()) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                if (isDayOfMonthVisible()) {</span>
<span class="nc" id="L389">                    week.setY(dayOfMonth.getY() + dayOfMonth.getHeight());</span>
                } else {
<span class="nc" id="L391">                    week.setY(dayOfWeek.getY() + dayOfWeek.getHeight());</span>
                }
            } else {
<span class="nc" id="L394">                week.setY(milestone.y + milestone.height);</span>
            }
<span class="nc bnc" id="L396" title="All 2 branches missed.">            if (isWeekVisible()) {</span>
<span class="nc" id="L397">                month.setY(week.getY() + week.getHeight());</span>
            } else {
<span class="nc" id="L399">                month.setY(dayOfWeek.getY() + dayOfWeek.getHeight());</span>
            }
<span class="nc" id="L401">            year.setY(month.getY() + month.getHeight());</span>
        } else {
            // year
            // month
            // week
            // dayOfMonth
            // milestone, dayOfWeek
            // flag
<span class="nc" id="L409">            year.setY(y);</span>
<span class="nc" id="L410">            month.setY(year.getY() + year.getHeight());</span>
<span class="nc" id="L411">            week.setY(month.getY() + month.getHeight());</span>
<span class="nc" id="L412">            dayOfMonth.setY(week.getY() + week.getHeight());</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">            if (isDayOfMonthVisible()) {</span>
<span class="nc" id="L414">                dayOfWeek.setY(dayOfMonth.getY() + dayOfMonth.getHeight());</span>
            } else {
<span class="nc" id="L416">                dayOfWeek.setY(week.getY() + week.getHeight());</span>
            }
<span class="nc" id="L418">            milestone.y     = dayOfWeek.getY();</span>
<span class="nc" id="L419">            milestone.flagY = dayOfWeek.getY() + milestone.height;</span>
        }
<span class="nc" id="L421">    }</span>

    public void initSize(int width, int dayWidth, boolean calendarAtBottom) {
<span class="nc" id="L424">        this.calendarAtBottom = calendarAtBottom;</span>
<span class="nc" id="L425">        this.width            = width;</span>
<span class="nc" id="L426">        dayOfWeek.setWidth(dayWidth);</span>
<span class="nc" id="L427">        dayOfMonth.setWidth(dayWidth);</span>
<span class="nc" id="L428">    }</span>

    public boolean isCalendarAtBottom() {
<span class="nc" id="L431">        return calendarAtBottom;</span>
    }

    private boolean isDayBarsVisible() {
<span class="nc bnc" id="L435" title="All 2 branches missed.">        return dayOfWeek.getWidth() &gt;= 4;</span>
    }

    private boolean isDayOfMonthVisible() {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        return dayOfWeek.getWidth() &gt;= DAY_OF_MONTH_MIN_DAY_WIDTH;</span>
    }

    private boolean isDayOfWeekVisible() {
<span class="nc bnc" id="L443" title="All 2 branches missed.">        return dayOfWeek.getWidth() &gt;= DAY_OF_WEEK_MIN_DAY_WIDTH;</span>
    }

    private boolean isMonthVisible() {
<span class="nc bnc" id="L447" title="All 2 branches missed.">        return dayOfWeek.getWidth() &gt;= MONTH_MIN_DAY_WIDTH;</span>
    }

    private boolean isWeekVisible() {
<span class="nc bnc" id="L451" title="All 2 branches missed.">        return dayOfWeek.getWidth() &gt;= WEEK_MIN_DAY_WIDTH;</span>
    }

    private boolean milestonesVisible() {
<span class="nc bnc" id="L455" title="All 2 branches missed.">        return !milestones.empty();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>