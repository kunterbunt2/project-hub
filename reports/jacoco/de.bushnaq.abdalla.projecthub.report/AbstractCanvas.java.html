<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCanvas.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project-hub</a> &gt; <a href="index.source.html" class="el_package">de.bushnaq.abdalla.projecthub.report</a> &gt; <span class="el_source">AbstractCanvas.java</span></div><h1>AbstractCanvas.java</h1><pre class="source lang-java linenums">/*
 *
 * Copyright (C) 2025-2025 Abdalla Bushnaq
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 */

package de.bushnaq.abdalla.projecthub.report;

import de.bushnaq.abdalla.profiler.Profiler;
import de.bushnaq.abdalla.profiler.SampleType;
import de.bushnaq.abdalla.projecthub.report.dao.GraphicsTheme;
import de.bushnaq.abdalla.projecthub.report.html.dao.ReportLink;
import de.bushnaq.abdalla.svg.util.ExtendedGraphics2D;
import de.bushnaq.abdalla.svg.util.ExtendedSvgGraphics2D;
import de.bushnaq.abdalla.util.FileUtil;
import org.apache.batik.anim.dom.SVGDOMImplementation;
import org.apache.batik.dom.GenericDOMImplementation;
import org.apache.batik.svggen.SVGGraphics2D;
import org.w3c.dom.DOMImplementation;
import org.w3c.dom.Document;

import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.*;
import java.nio.charset.StandardCharsets;


public abstract class AbstractCanvas extends ReportLink {
    private static final float              fine_LINE_STROKE_WIDTH = 1f;
<span class="nc" id="L41">    private              int                borderWidth            = 1;</span>
    private              int                chartHeight;
    private              int                chartWidth;
    protected            ExtendedGraphics2D graphics2D;
    protected            GraphicsTheme      graphicsTheme;
    protected            String             imageName;
    //    private final        Logger             logger                 = LoggerFactory.getLogger(this.getClass());
    protected            SVGGraphics2D      svgGenerator;

    public AbstractCanvas(String column, String imageName/*, String mapName*/, String link, String cssClass, GraphicsTheme graphicsTheme)
            throws IOException {
<span class="nc" id="L52">        super(column, generateCellText(cssClass/*, mapName*/, imageName), link);</span>
<span class="nc" id="L53">        this.imageName     = imageName;</span>
<span class="nc" id="L54">        this.graphicsTheme = graphicsTheme;</span>
<span class="nc" id="L55">    }</span>

    protected abstract void createReport() throws Exception;

    protected void drawBackground() {
<span class="nc" id="L60">        graphics2D.setColor(graphicsTheme.chartBackgroundColor);</span>
<span class="nc" id="L61">        graphics2D.fillRect(0, 0, getChartWidth(), getChartHeight());</span>
<span class="nc" id="L62">    }</span>

    private void drawBorder(ExtendedGraphics2D g2) {
<span class="nc" id="L65">        g2.setStroke(new BasicStroke(fine_LINE_STROKE_WIDTH));</span>
<span class="nc" id="L66">        g2.setColor(graphicsTheme.chartBorderColor);</span>
<span class="nc" id="L67">        g2.drawRect(0, 0, getChartWidth() - 1, getChartHeight() - 1);</span>
<span class="nc" id="L68">    }</span>

    protected abstract void drawCaption(ExtendedGraphics2D graphics2d2);

    protected abstract void drawFooter(ExtendedGraphics2D graphics2d2);

    private static String generateCellText(String cssClass/*, String mapName*/, String imageName) {
<span class="nc" id="L75">        String extension = &quot;svg&quot;;</span>
//        return String.format(&quot;&lt;img class=\&quot;%s\&quot; usemap=\&quot;#%s\&quot; border=\&quot;0\&quot; src=\&quot;%s.%s\&quot;&gt;&quot;, cssClass, mapName, imageName, extension);
<span class="nc" id="L77">        return String.format(&quot;&lt;img class=\&quot;%s\&quot; border=\&quot;0\&quot; src=\&quot;%s.%s\&quot;&gt;&quot;, cssClass, imageName, extension);</span>
    }

    public int getBorderWidth() {
<span class="nc" id="L81">        return borderWidth;</span>
    }

    public int getChartHeight() {
<span class="nc" id="L85">        return chartHeight;</span>
    }

    public int getChartWidth() {
<span class="nc" id="L89">        return chartWidth;</span>
    }

    public String getImageName() {
<span class="nc" id="L93">        return imageName;</span>
    }

    protected void prepareGraphics(final BufferedImage aImage) throws IOException {
<span class="nc" id="L97">        graphics2D = new ExtendedGraphics2D((Graphics2D) aImage.getGraphics());</span>
<span class="nc" id="L98">        graphics2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);</span>
<span class="nc" id="L99">        graphics2D.setRenderingHint(RenderingHints.KEY_RENDERING, RenderingHints.VALUE_RENDER_QUALITY);</span>
<span class="nc" id="L100">        graphics2D.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);</span>
<span class="nc" id="L101">        graphics2D.setRenderingHint(RenderingHints.KEY_FRACTIONALMETRICS, RenderingHints.VALUE_FRACTIONALMETRICS_ON);</span>
<span class="nc" id="L102">    }</span>

    protected void prepareSvgGraphics() throws IOException {
        // Get a DOMImplementation.
<span class="nc" id="L106">        DOMImplementation domImpl = GenericDOMImplementation.getDOMImplementation();</span>
        // Create an instance of org.w3c.dom.Document.
<span class="nc" id="L108">        String   svgNS    = SVGDOMImplementation.SVG_NAMESPACE_URI;</span>
<span class="nc" id="L109">        Document document = domImpl.createDocument(svgNS, &quot;svg&quot;, null);</span>
        // Create an instance of the SVG Generator.
<span class="nc" id="L111">        svgGenerator = new ExtendedSvgGraphics2D(document);</span>
        // Ask the test to render into the SVG Graphics2D implementation.
<span class="nc" id="L113">        svgGenerator.setSVGCanvasSize(new Dimension(chartWidth, chartHeight));</span>
<span class="nc" id="L114">        graphics2D = new ExtendedGraphics2D(svgGenerator);</span>
        //        graphics2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
        //        graphics2D.setRenderingHint(RenderingHints.KEY_RENDERING, RenderingHints.VALUE_RENDER_QUALITY);
        //        graphics2D.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING, RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
        //        graphics2D.setRenderingHint(RenderingHints.KEY_FRACTIONALMETRICS, RenderingHints.VALUE_FRACTIONALMETRICS_ON);
<span class="nc" id="L119">    }</span>

    public void render(String copyright, ByteArrayOutputStream o) throws Exception {
<span class="nc" id="L122">        try (Profiler p1 = new Profiler(SampleType.GPU)) {</span>
<span class="nc" id="L123">            prepareSvgGraphics();</span>
<span class="nc" id="L124">            drawBackground();</span>
<span class="nc" id="L125">            drawCaption(graphics2D);</span>
<span class="nc" id="L126">            createReport();</span>
<span class="nc" id="L127">            drawFooter(graphics2D);</span>
<span class="nc" id="L128">            drawBorder(graphics2D);</span>
<span class="nc" id="L129">            try (Profiler p2 = new Profiler(SampleType.FILE)) {</span>
<span class="nc" id="L130">                boolean useCSS = true; // we want to use CSS style attributes</span>
<span class="nc" id="L131">                Writer  out    = new OutputStreamWriter(o, StandardCharsets.UTF_8);</span>
<span class="nc" id="L132">                svgGenerator.stream(out, useCSS);</span>
            }
        }

<span class="nc" id="L136">    }</span>

    public void render(String copyright, String description, String path) throws Exception {
<span class="nc" id="L139">        try (Profiler p1 = new Profiler(SampleType.GPU)) {</span>
            String imageFileName;
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (path.isEmpty()) {</span>
<span class="nc" id="L142">                imageFileName = String.format(&quot;%s.svg&quot;, imageName);</span>
            } else {
<span class="nc" id="L144">                imageFileName = String.format(path + &quot;/%s.svg&quot;, imageName);</span>
            }
<span class="nc" id="L146">            prepareSvgGraphics();</span>
<span class="nc" id="L147">            drawBackground();</span>
<span class="nc" id="L148">            drawCaption(graphics2D);</span>
<span class="nc" id="L149">            createReport();</span>
<span class="nc" id="L150">            drawFooter(graphics2D);</span>
<span class="nc" id="L151">            drawBorder(graphics2D);</span>
<span class="nc" id="L152">            try (Profiler p2 = new Profiler(SampleType.FILE)) {</span>
<span class="nc" id="L153">                boolean          useCSS = true; // we want to use CSS style attributes</span>
<span class="nc" id="L154">                FileOutputStream o      = new FileOutputStream(imageFileName);</span>
<span class="nc" id="L155">                Writer           out    = new OutputStreamWriter(o, StandardCharsets.UTF_8);</span>
<span class="nc" id="L156">                svgGenerator.stream(out, useCSS);</span>
            }
<span class="nc" id="L158">            text = FileUtil.loadFile(null, imageFileName).replace(&quot;&lt;svg &quot;, &quot;&lt;svg class=\&quot;qtip-shadow\&quot;&quot;);</span>
        }
<span class="nc" id="L160">    }</span>

    public void setBorderWidth(int borderWidth) {
<span class="nc" id="L163">        this.borderWidth = borderWidth;</span>
<span class="nc" id="L164">    }</span>

    public void setChartHeight(int chartHeight) {
<span class="nc" id="L167">        this.chartHeight = chartHeight + getBorderWidth();</span>
<span class="nc" id="L168">    }</span>

    public void setChartWidth(int chartWidth) {
<span class="nc" id="L171">        this.chartWidth = chartWidth + getBorderWidth();</span>
<span class="nc" id="L172">    }</span>

    public static int transformToMapX(int x) {
<span class="nc" id="L175">        return x;</span>
    }

    public static int transformToMapY(int y) {
<span class="nc" id="L179">        return y;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>